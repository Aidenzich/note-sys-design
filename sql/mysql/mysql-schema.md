> ðŸ“Œ æ­¤æ–‡ä»¶ä¾†è‡ª https://ithelp.ithome.com.tw/users/20177857/ironman çš„ IT é‚¦éµäººè³½æ•™ç¨‹ï¼Œåƒ…é‡å°å€‹äººå­¸ç¿’ç”¨é€”é€²è¡Œç­†è¨˜èˆ‡ä¿®æ”¹ã€‚

# MySQL çš„ Schema ç®¡ç†

Transaction ACID ä¸­çš„ Consistency è¦æ±‚è³‡æ–™æ›´æ–°å‰å¾Œè¦ç¬¦åˆè³‡æ–™è¦å‰‡ï¼Œç¢ºä¿è³‡æ–™æ­£ç¢ºï¼Œè€Œè³‡æ–™è¦å‰‡ä¸»è¦æ˜¯é€éŽ Schema ä¾†åˆ¶å®šçš„ï¼Œä¾‹å¦‚ Data Type & Constraint ç­‰ï¼Œå¯¦å‹™ä¸Š Schema å¾ˆé›£å»ºç«‹äº†å°±ä¸ä¿®æ”¹ï¼Œä¿®æ”¹ Schema çš„ SQL é›–ç„¶å¾ˆç°¡å–®ï¼Œä½†å…¶ä¸­å»æš—è—é™·é˜±ï¼Œä¸€ä¸å°å¿ƒå°±æœƒ Lock Table å°Žè‡´æŸ¥è©¢å¯«å…¥å…¨éƒ¨å¡ä½ã€‚

## MySQL Schema å„²å­˜åœ¨å“ªè£¡ï¼Ÿ

8.0 å‰å„²å­˜åœ¨ `.frm` æª”æ¡ˆï¼Œ**8.0 å¾Œå‰‡å„²å­˜åˆ° system table space çš„ `.idb` ä¸¦å°‡ Schema è³‡æ–™è¦–ç‚ºç´€éŒ„ï¼Œèƒ½ä½¿ç”¨ Transaction åŽ»æ›´æ–°**ï¼Œä½†ä¸è«– `.firm` é‚„æ˜¯ system table space ï¼ŒSchema è³‡æ–™èˆ‡è³‡æ–™æ˜¯åˆ†é–‹å„²å­˜ï¼Œå¥½è™•å°±æ˜¯çœç©ºé–“ï¼Œä¸ç”¨æ¯è³‡æ–™éƒ½å¦å¤–å„²å­˜ Schema è³‡æ–™ã€‚

## æ—¢ç„¶æ˜¯åˆ†é–‹å„²å­˜ï¼Œé‚£éº¼æ›´æ–° Schema æ™‚ï¼Œå°±ä¸æœƒåŽ»æ›´æ–°åˆ°è³‡æ–™å°å—Žï¼Ÿ

ç­”æ¡ˆæ˜¯ä¸ä¸€å®šï¼Œä¾‹å¦‚ `ALTER TABLE users ADD COLUMN count SMALLINT NOT NULL AFTER name` ï¼Œæ–°å¢žæ¬„ä½æ™‚åŠ äº† AFTER å°±éœ€è¦åŽ»æ›´æ–°è³‡æ–™ï¼Œè€Œæ›´æ–°å‹¢å¿…è¦ä¸ŠéŽ–ï¼Œå°±æœƒå°Žè‡´ Table Lockï¼Œå¦‚æžœ Table è³‡æ–™å¤šï¼ŒéŽ–çš„æ™‚é–“å°±æœƒå¾ˆä¹…ã€‚

åŽŸå› åœ¨æ–¼ Page å„²å­˜è³‡æ–™çš„æ ¼å¼æ˜¯ Schema å®šç¾©çš„ï¼Œä¾‹å¦‚

```sql!
create table users (  
	id int auto_increment,  
	name char(100),  
	gender int,  
	primary key (id)  
); 
```

è³‡æ–™æ ¼å¼ç‚ºï¼Œ`[4bytes | 100 bytes | 4 bytes]`ï¼Œå‰ 4 bytes ä»£è¡¨ idï¼Œä¸­é–“ 100 bytes æ˜¯ name ï¼Œæœ€å¾Œ 4 bytes æ˜¯ genderï¼Œå¦‚æžœåŸ·è¡Œ `ALTER TABLE users ADD COLUMN count SMALLINT NOT NULL AFTER name` æ ¼å¼æœƒè®Šæˆ `[4bytes | 100 bytes | 2 bytes | 4 bytes]`ï¼Œè‹¥ `idb` æª”æ¡ˆä¸­è³‡æ–™æ²’æ›´æ–°ï¼Œè®€è³‡æ–™æ™‚ä¾ç…§æ–°çš„ Schema è§£æžå°±æœƒå‡ºéŒ¯ã€‚

## é‚£éº¼åªè¦ ADD COLUMN éƒ½æœƒè®Šå‹•æ ¼å¼ï¼Œéƒ½æœƒ Lock Table ä¸€æ®µæ™‚é–“å—Žï¼Ÿ

ä¸ä¸€å®šï¼MySQL ä¿®æ”¹ Schema çš„æ¼”ç®—æ³•æœ‰ä¸‰å€‹ï¼ŒCopy & Instant & InPlace ã€‚

- **Copy** - å»ºç«‹æ–°çš„ idb æª”ï¼ŒæŠŠèˆŠçš„è³‡æ–™ä¾ç…§æ–°çš„æ ¼å¼æ¬ç§»éŽåŽ»ï¼Œç„¶å¾Œå†åˆªé™¤èˆŠçš„ idb æª”ï¼Œä¸”æ¬ç§»éŽç¨‹ä¸­è¦å°è³‡æ–™ä¸ŠéŽ–ï¼Œé¿å…èˆŠ idb æª”æ¡ˆè¢«æ›´æ–°æ²’åŒæ­¥åˆ°æ–° idb æª”æ¡ˆã€‚

- **Instant** - åªä¿®æ”¹ Schema è³‡æ–™ï¼ŒTable Lock æ™‚é–“å¾ˆçŸ­ã€‚
å¦‚æžœ ADD COLUMN åœ¨ Schema å°¾ç«¯ä¸”å¯ç‚º NULL æˆ–æœ‰ Default Valueï¼ŒMySQL å°±æœƒç”¨ Instant ç®—æ³•ï¼ŒåŸ·è¡Œæœƒéžå¸¸å¿«ï¼Œä½†è³‡æ–™æ ¼å¼æœ‰è®Šï¼Œè§£æžä¸æœƒæœ‰å•é¡Œå—Žï¼Ÿ
åŸ·è¡Œ ALTER TABLE users ADD COLUMN count SMALLINT NOT NULL DEFAULT 1 ï¼Œè³‡æ–™æ ¼å¼æœƒè®Šæˆ [4bytes | 100 bytes | 4 bytes | 2 bytes ]ï¼Œè§£æžèˆŠæ ¼å¼æ™‚ç™¼ç¾è³‡æ–™é•·åº¦ä¸å¤ ï¼Œå¯ä»¥è‡ªå‹•è£œé è¨­å€¼ï¼Œå› æ­¤ä¸æ›´æ–°è³‡æ–™ä¹Ÿä¸æœƒè§£æžéŒ¯èª¤ã€‚
å› æ­¤åƒæ˜¯ ALTER COLUMN NAME or ADD COMMENT ç­‰ä¸æœƒç ´å£žè³‡æ–™æ ¼å¼çš„ Migration éƒ½æœƒç”¨ Instantï¼Œè€Œä¿®æ”¹ Data Type è·Ÿ ADD COLUMN AFTER ç­‰æœƒç ´å£žè³‡æ–™æ ¼å¼çš„ Migration æœƒç”¨ Copyã€‚é™¤äº† Column èª¿æ•´ï¼ŒADD INDEX ä¹Ÿæ˜¯å¸¸è¦‹çš„ Migrationï¼Œå»ºç«‹æ–°çš„ Index é›–ä¸æœƒå½±éŸ¿è³‡æ–™æ ¼å¼ï¼Œä½†éœ€è¦ç‚ºæ¯ç­†è³‡æ–™å»ºç«‹æ–°çš„ Index Treeï¼Œå› æ­¤æœƒæ­¤ç”¨ InPace ã€‚

- **InPlace** - ä¸æœƒå»ºç«‹æ–°çš„ `.idb` æª”æ¡ˆï¼Œè€Œæ˜¯åœ¨åŽŸæœ‰çš„ `.idb` æª”æ¡ˆä¸­æ“´å±•æ–°ç©ºé–“å¡žæ–°è³‡æ–™ï¼Œå¡žå®Œæ–°è³‡æ–™å¾Œæœƒæ‹¿ Table Lock ä¸¦æ›´æ–° Schema å…§å®¹ï¼Œä¸ŠéŽ–æ™‚é–“ä¸å¤šï¼ŒInPlace é€éŽå…©å€‹æ©Ÿåˆ¶å®Œæˆï¼š
    - **Background Thread** : åœ¨èƒŒæ™¯åŸ·è¡Œå°‡åŽŸæœ‰è³‡æ–™åŒæ­¥åˆ°æ–°ç©ºé–“ï¼Œä¾‹å¦‚å°‡åŽŸæœ‰è³‡æ–™ä¸€ç­†ç­†å»ºç«‹æ–°çš„ Index ã€‚
    - **Online Alter Log**ï¼šç”±æ–¼ InPlace åŸ·è¡Œä¸æœƒ Lockï¼Œå› æ­¤è³‡æ–™æœƒä¸æ–·è¢«æ›´æ–°ï¼Œæœƒå°Žè‡´ Background Thread åŒæ­¥å®ŒæŸç­†è³‡æ–™å¾Œï¼Œè©²ç­†è³‡æ–™åˆè¢«æ›´æ–°ï¼Œé€™æ™‚éœ€è¦ä¸€å€‹æ©Ÿåˆ¶è¿½è¹¤é€™äº›å¾Œä¾†è¢«æ›´æ–°çš„å…§å®¹ï¼Œæ‰€ä»¥ MySQL ç”¨é¡å¤–çš„ Log çµæ§‹åŽ»å„²å­˜ Background Thread åŸ·è¡ŒéŽç¨‹ä¸­çš„æ‰€æœ‰ä¿®æ”¹å…§å®¹ï¼Œä¸¦åœ¨ Background Thread åŸ·è¡Œå®Œå¾Œé‡æ”¾ Log çš„å…§å®¹å»ºç«‹æ–°çš„è³‡æ–™ã€‚

å…¶å¯¦ç†è«–ä¸Š `ADD COLUMN` è‹¥å½±éŸ¿è³‡æ–™æ ¼å¼ä¹Ÿå¯åƒè€ƒ InPlace ç®—æ³•å¯¦ä½œï¼Œå¯æƒœ MySQL æœƒç”¨ COPY ç®—æ³•ï¼Œä½†å¦‚æžœä½ æœƒèª¿æ•´è³‡æ–™æ ¼å¼åˆä¸æƒ³ Lock Table é‚£éº¼ä¹…ï¼Œå¯ä»¥ç”¨ **online-schema-change** å·¥å…·ï¼Œå…¶æ¦‚å¿µæ˜¯ InPlace + Copy æ•´åˆï¼Œä»–çš„æµç¨‹æ˜¯ï¼š

1. å»ºç«‹æ–° Schema çš„ Table (e.g new_users)
2. åœ¨èˆŠçš„ Table (e.g users) å»ºç«‹ä¸€å€‹ `INSERT` & `UPDATE` & `DELETE` ä¸‰ç¨® triggerï¼Œé€éŽ trigger åŒæ­¥èˆŠ Table çš„ç•°å‹•åˆ°æ–° table
3. ä½¿ç”¨ Primary Key æ‰¹æ¬¡æ¬ç§»èˆŠè³‡æ–™åˆ°æ–°è³‡æ–™
4. è³‡æ–™æ¬å®Œå¾Œï¼Œæœƒç²å–æ–°èˆŠå…©å€‹ Table çš„ Table Lock ç„¶å¾Œ rename æ–° Table åç¨±è·ŸèˆŠ Table åç¨± (e.g users -> old_users; new_users -> users)
5. ç§»é™¤èˆŠ Table (e.g old_users)

